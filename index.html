<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKAZUstudio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="flex flex-col h-screen">

    <!-- Brush Cursor -->
    <div id="brush-cursor"></div>

    <!-- Drag Overlay -->
    <div id="drag-overlay" class="absolute inset-0 z-50 pointer-events-none items-center justify-center">
        <div class="text-white text-3xl font-bold bg-black/50 px-8 py-4 rounded-xl backdrop-blur-sm">
            Drop Images Here
        </div>
    </div>

    <!-- Modal Dialog -->
    <div id="modal-overlay" class="fixed inset-0 z-[100] flex items-center justify-center backdrop-blur-sm transition-opacity duration-200 opacity-0 hidden" style="background-color: rgba(0,0,0,0.8);">
        <div id="modal-box" class="bg-panel-strong border border-panel-border rounded-lg shadow-2xl max-w-md w-full overflow-hidden transform scale-95 transition-all duration-200 p-0">
            <div class="flex items-center justify-between px-4 py-2 border-b border-panel-divider bg-panel-header">
                <h3 id="modal-title" class="text-lg font-bold text-accent translate-y-[1px]">Confirm</h3>
                <button id="modal-close" class="accent-action rounded-sm shadow-sm flex items-center justify-center">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4">
                <p id="modal-message" class="text-gray-300 mb-4 font-medium leading-relaxed"></p>
                <div id="modal-choices" class="flex flex-col gap-2">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Error Console -->
    <div id="error-console"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex flex-col items-center justify-center hidden">
        <div class="spinner mb-4"></div>
        <div class="text-white font-bold text-xl">PROCESSING</div>
    </div>

    <!-- Hint Legend -->
    <div id="hint-legend" class="flex flex-col">
        <div class="flex justify-between gap-4">
            <div><span class="key">Space</span> <span class="text-gray-400 text-xs">(Hold)</span></div>
            <div class="text-right">Pan</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Middle Drag</span></div>
            <div class="text-right">Pan</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Wheel</span></div>
            <div class="text-right">Zoom</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Shift+Drag</span></div>
            <div class="text-right">Precision Zoom</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Space</span> <span class="text-gray-400 text-xs">(Double-tap)</span></div>
            <div class="text-right">Reset View</div>
        </div>
        <div class="flex justify-between gap-4 mt-3">
            <div><span class="key">Ctrl+Wheel</span> <span class="text-gray-500">/</span> <span class="key">[ ]</span></div>
            <div class="text-right">Brush Size</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Ctrl+Click</span></div>
            <div class="text-right">Draw Line</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">1</span> <span class="key">2</span> <span class="key">3</span></div>
            <div class="text-right">Brush Modes</div>
        </div>
        <div class="flex justify-between gap-4 mt-3">
            <div><span class="key">Ctrl+Z</span> <span class="text-gray-500">/</span> <span class="key">Shift+Z</span></div>
            <div class="text-right">Undo / Redo</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Ctrl</span> + <span class="key">+</span> <span class="text-gray-500">/</span> <span class="key">-</span></div>
            <div class="text-right">UI Scale</div>
        </div>
    </div>

    <!-- Crop Mode Legend (Hidden by default) -->
    <div id="crop-hint-legend" class="flex flex-col" style="display: none; opacity: 0; position: absolute; top: 60px; right: 50px; z-index: 20; background: rgba(0, 0, 0, 0.7); padding: 8px 12px; border-radius: 6px; font-size: 11px; color: #ccc; pointer-events: none; text-align: left; border: 1px solid rgba(255,255,255,0.1); transition: opacity 0.5s ease-in-out;">
        <div class="flex justify-between gap-4">
            <div><span class="key">Enter</span></div>
            <div class="text-right">Apply</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Esc</span></div>
            <div class="text-right">Cancel</div>
        </div>
        <div class="flex justify-between gap-4 mt-3">
            <div><span class="key">Drag</span></div>
            <div class="text-right">Move / Resize</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Shift+Drag</span></div>
            <div class="text-right">Scale</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Ctrl+Drag</span></div>
            <div class="text-right">Rotate</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Space</span> <span class="text-gray-400 text-xs">(Double-tap)</span></div>
            <div class="text-right">Reset Rotation</div>
        </div>
        <div class="flex justify-between gap-4 mt-3">
            <div><span class="key">Space</span> <span class="text-gray-500">/</span> <span class="key">Middle Drag</span></div>
            <div class="text-right">Pan View</div>
        </div>
        <div class="flex justify-between gap-4 mt-1">
            <div><span class="key">Wheel</span></div>
            <div class="text-right">Zoom</div>
        </div>
    </div>

    <!-- Drawer 1: Adjustments (Top) -->
    <div id="drawer-adj" class="side-drawer flex items-start z-50">
        <!-- Lip -->
        <div class="w-6 h-24 bg-panel-strong rounded-l-lg border-y border-l border-panel flex items-center justify-center cursor-pointer shadow-lg">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </div>
        <!-- Drawer Content -->
        <div class="drawer-content w-72 bg-panel border border-panel shadow-2xl rounded-bl-lg overflow-y-auto max-h-[85vh]">
            <div class="drawer-inner p-4">
                 <div class="flex justify-between items-center mb-4 border-b border-panel-divider pb-2">
                    <h3 class="text-xs font-bold text-gray-400">Adjustments</h3>
                    <button id="resetAdjBtn" class="text-xs text-accent hover:text-white font-bold">Reset All</button>
                </div>
                <!-- Sliders -->
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Gamma</span> <span id="val-gamma" class="val-display">1.00</span></div>
                    <input id="adj-gamma" type="range" autocomplete="off" min="0.0" max="2.0" step="0.01" value="1.0" class="w-full" data-default="1.0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Shadows</span> <span id="val-shadows" class="val-display">0</span></div>
                    <input id="adj-shadows" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Highlights</span> <span id="val-highlights" class="val-display">0</span></div>
                    <input id="adj-highlights" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-divider"></div>
                <div class="section-header">
                    <span class="section-title">Levels</span>
                    <button id="resetLevelsBtn" class="section-reset">Reset</button>
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Black Point</span> <span id="val-l-black" class="val-display">0</span></div>
                    <input id="adj-l-black" type="range" autocomplete="off" min="0" max="255" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Mid Point</span> <span id="val-l-mid" class="val-display">1.00</span></div>
                    <input id="adj-l-mid" type="range" autocomplete="off" min="0.0" max="2.0" step="0.01" value="1.0" class="w-full" data-default="1.0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>White Point</span> <span id="val-l-white" class="val-display">255</span></div>
                    <input id="adj-l-white" type="range" autocomplete="off" min="0" max="255" value="255" class="w-full" data-default="255">
                </div>
                <div class="drawer-divider"></div>
                 <div class="section-header">
                    <span class="section-title">Color</span>
                    <button id="resetSatBtn" class="section-reset">Reset</button>
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Saturation</span> <span id="val-sat" class="val-display">0</span></div>
                    <input id="adj-sat" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>
                 <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Vibrance</span> <span id="val-vib" class="val-display">0</span></div>
                    <input id="adj-vib" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-divider"></div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>White Balance</span> <span id="val-wb" class="val-display">6500K</span></div>
                    <input id="adj-wb" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-divider"></div>
                <div class="section-header">
                    <span class="section-title">Color Balance</span>
                    <button id="resetColorBtn" class="section-reset">Reset</button>
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Cyan - Red</span> <span id="val-cb-r" class="val-display">0</span></div>
                    <input id="adj-cb-r" type="range" autocomplete="off" min="-100" max="100" step="0.4" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Magenta - Green</span> <span id="val-cb-g" class="val-display">0</span></div>
                    <input id="adj-cb-g" type="range" autocomplete="off" min="-100" max="100" step="0.4" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Yellow - Blue</span> <span id="val-cb-b" class="val-display">0</span></div>
                    <input id="adj-cb-b" type="range" autocomplete="off" min="-100" max="100" step="0.4" value="0" class="w-full" data-default="0">
                </div>
            </div>
        </div>
    </div>

    <!-- Drawer 2: Color Tuning (Middle) -->
    <div id="drawer-tools" class="side-drawer flex items-center z-40">
        <!-- Lip -->
        <div class="w-6 h-24 bg-panel-strong rounded-l-lg border-y border-l border-panel flex items-center justify-center cursor-pointer shadow-lg">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </div>
        <!-- Drawer Content -->
        <div class="drawer-content w-72 bg-panel border border-panel shadow-2xl rounded-bl-lg overflow-y-auto max-h-[85vh]">
            <div class="drawer-inner p-4">
                <div class="flex justify-between items-center mb-4 border-b border-panel-divider pb-2">
                    <h3 class="text-xs font-bold text-gray-400">Color Tuning</h3>
                </div>

                <!-- Band Selector Grid -->
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <button id="band-red" class="h-8 rounded grad-red border-2 border-transparent hover:border-white/50 transition-all active-band" data-band="red"></button>
                    <button id="band-orange" class="h-8 rounded grad-orange border-2 border-transparent hover:border-white/50 transition-all" data-band="orange"></button>
                    <button id="band-yellow" class="h-8 rounded grad-yellow border-2 border-transparent hover:border-white/50 transition-all" data-band="yellow"></button>
                    <button id="band-green" class="h-8 rounded grad-green border-2 border-transparent hover:border-white/50 transition-all" data-band="green"></button>
                    <button id="band-aqua" class="h-8 rounded grad-aqua border-2 border-transparent hover:border-white/50 transition-all" data-band="aqua"></button>
                    <button id="band-blue" class="h-8 rounded grad-blue border-2 border-transparent hover:border-white/50 transition-all" data-band="blue"></button>
                    <button id="band-purple" class="h-8 rounded grad-purple border-2 border-transparent hover:border-white/50 transition-all" data-band="purple"></button>
                    <button id="band-magenta" class="h-8 rounded grad-magenta border-2 border-transparent hover:border-white/50 transition-all" data-band="magenta"></button>
                </div>

                <!-- Luminance Band Row -->
                <div class="tuning-lum-row">
                    <button id="band-darks" class="band-darks" data-band="darks"></button>
                    <button id="band-mids" class="band-mids" data-band="mids"></button>
                    <button id="band-lights" class="band-lights" data-band="lights"></button>
                </div>

                <!-- Sliders -->
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Hue</span> <span id="val-tune-hue" class="val-display">0</span></div>
                    <input id="tune-hue" type="range" autocomplete="off" min="-180" max="180" step="1" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Saturation</span> <span id="val-tune-sat" class="val-display">0</span></div>
                    <input id="tune-sat" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Vibrance</span> <span id="val-tune-vib" class="val-display">0</span></div>
                    <input id="tune-vib" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>

                <div class="drawer-divider"></div>

                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Luminance</span> <span id="val-tune-lum" class="val-display">0</span></div>
                    <input id="tune-lum" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Shadows</span> <span id="val-tune-shadows" class="val-display">0</span></div>
                    <input id="tune-shadows" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>
                <div class="drawer-slider-group">
                    <div class="drawer-label"><span>Highlights</span> <span id="val-tune-highlights" class="val-display">0</span></div>
                    <input id="tune-highlights" type="range" autocomplete="off" min="-100" max="100" value="0" class="w-full" data-default="0">
                </div>

                <div class="drawer-divider"></div>

                <div class="flex gap-2 mt-4">
                     <button id="resetBandBtn" class="w-1/2 py-1.5 rounded text-xs font-bold border border-panel bg-panel-strong panel-btn hover:text-white">
                        Reset Band
                    </button>
                    <button id="resetTuningBtn" class="w-1/2 py-1.5 rounded text-xs font-bold border border-panel bg-panel-strong panel-btn text-accent hover:text-white">
                        Reset All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Drawer 3: Advanced Tools (Bottom) -->
    <div id="drawer-layers" class="side-drawer flex items-end z-30">
        <!-- Lip -->
        <div class="w-6 h-24 bg-panel-strong rounded-l-lg border-y border-l border-panel flex items-center justify-center cursor-pointer shadow-lg">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </div>
        <!-- Drawer Content -->
        <div class="drawer-content w-72 bg-panel border border-panel shadow-2xl rounded-tl-lg overflow-y-auto max-h-[85vh]">
            <div class="drawer-inner p-4">
                 <div class="flex justify-between items-center mb-4 border-b border-panel-divider pb-2">
                    <h3 class="text-xs font-bold text-gray-400">Advanced Tools</h3>
                </div>
                <p class="text-xs text-gray-500">Layer management coming soon.</p>
            </div>
        </div>
    </div>

    <!-- Vertical Toolbox (Left) -->
    <div id="vertical-toolbox" style="top: max(30%, calc(300px + 48px));" class="absolute left-0 transform -translate-y-1/2 bg-panel border-y border-r border-panel rounded-r-lg p-2 flex flex-col gap-2 z-40 shadow-xl">
        <!-- Undo / Redo -->
        <div class="flex flex-col gap-2 border-b border-panel-divider pb-2 mb-1">
            <button id="undoBtn" class="icon-btn" title="Undo" disabled>
                <img src="icons/undo.svg" alt="Undo" class="w-5 h-5" draggable="false">
            </button>
            <button id="redoBtn" class="icon-btn" title="Redo" disabled>
                <img src="icons/redo.svg" alt="Redo" class="w-5 h-5" draggable="false">
            </button>
        </div>
        <!-- View Toggles -->
        <div class="flex flex-col gap-2 border-b border-panel-divider pb-2 mb-1">
            <button id="toggleBackBtn" class="icon-btn" title="Toggle Rear Image Visibility">
                <img id="rearEyeOpen" src="icons/back_show.svg" alt="Show Back" class="w-5 h-5" draggable="false">
                <img id="rearEyeClosed" src="icons/back_hide.svg" alt="Hide Back" class="w-5 h-5 hidden" draggable="false">
            </button>
            <button id="toggleMaskBtn" class="icon-btn" title="Toggle Holes Visibility">
                <img id="maskEyeOpen" src="icons/edits_show.svg" alt="Show Edits" class="w-5 h-5" draggable="false">
                <img id="maskEyeClosed" src="icons/edits_hide.svg" alt="Hide Edits" class="w-5 h-5 hidden" draggable="false">
            </button>
            <button id="toggleAdjBtn" class="icon-btn" title="Toggle Adjustments Visibility">
                <img id="adjEyeOpen" src="icons/filters_show.svg" alt="Show Adjustments" class="w-5 h-5" draggable="false">
                <img id="adjEyeClosed" src="icons/filters_hide.svg" alt="Hide Adjustments" class="w-5 h-5 hidden" draggable="false">
            </button>
        </div>

        <!-- Crop & Rotate Tool -->
        <div class="flex flex-col gap-2 border-b border-gray-700 pb-2 mb-1">
            <button id="cropBtn" class="icon-btn hover:text-yellow-400" title="Crop">
                <img src="icons/crop.svg" alt="Crop" class="w-5 h-5" draggable="false">
            </button>
            <button id="rotateBtn" class="icon-btn hover:text-blue-400" title="Rotate">
                <img src="icons/rotate_cw.svg" alt="Rotate View" class="w-5 h-5" draggable="false">
            </button>
        </div>

        <!-- Actions -->
        <button id="censorBtn" class="icon-btn text-purple-400" title="Censor">
            <img src="icons/censor.svg" alt="Censor" class="w-5 h-5" draggable="false">
        </button>
        <button id="mergeBtn" class="icon-btn hover:text-green-400" title="Merge">
            <img src="icons/merge.svg" alt="Merge" class="w-5 h-5" draggable="false">
        </button>
        <button id="clearMask" class="icon-btn hover:text-red-400" title="Reset">
            <img src="icons/reset.svg" alt="Reset" class="w-5 h-5" draggable="false">
        </button>
    </div>

    <!-- Top Toolbar -->
    <div class="h-12 bg-panel border-b border-panel flex items-center gap-4 px-4 z-50 shrink-0 overflow-visible relative" style="cursor: default;">
        <button id="newBtn" class="tool-btn flex items-center gap-2 text-white px-3 py-1.5 rounded shadow text-xs font-medium accent-action" title="New">
            <img src="icons/new.svg" alt="New" class="w-4 h-4" draggable="false">
            <span>New</span>
        </button>
        <div class="flex flex-row gap-2 shrink-0">
            <!-- Front Group -->
            <div class="flex gap-1">
                <input type="file" id="fileA" accept="image/*" class="hidden">
                <button onclick="document.getElementById('fileA').click()" id="btnA" class="relative tool-btn px-2 py-1 text-xs font-bold rounded border border-panel panel-btn w-24 leading-tight">
                    Load
                    <span class="absolute bottom-[-11px] left-0 right-0 text-center text-[8px] text-gray-600 font-normal leading-none pointer-events-none">front</span>
                </button>
                <button id="btnTrashA" class="tool-btn py-1 rounded border border-panel panel-btn aspect-square flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" height="14" viewBox="0 -960 960 960" width="14" fill="currentColor"><path d="M261-120q-24.75 0-42.37-17.63Q201-155.25 201-180v-570h-41v-60h188v-30h264v30h188v60h-41v570q0 24-18 42t-42 18H261Zm438-630H261v570h438v-570ZM367-266h60v-399h-60v399Zm166 0h60v-399h-60v399ZM261-750v570-570Z"/></svg>
                </button>
            </div>
            <!-- Swap Button -->
            <button id="swapBtn" class="tool-btn py-1 rounded border border-panel panel-btn aspect-square flex items-center justify-center hover-accent" title="Swap">
                <svg xmlns="http://www.w3.org/2000/svg" height="14" viewBox="0 -960 960 960" width="14" fill="currentColor"><path d="M273-160 80-353l193-193 42 42-121 121h316v60H194l121 121-42 42Zm414-254-42-42 121-121H450v-60h316L645-758l42-42 193 193-193 193Z"/></svg>
            </button>
            <!-- Back Group -->
            <div class="flex gap-1">
                <input type="file" id="fileB" accept="image/*" class="hidden">
                <button onclick="document.getElementById('fileB').click()" id="btnB" class="relative tool-btn px-2 py-1 text-xs font-bold rounded border border-panel panel-btn w-24 leading-tight">
                    Load
                    <span class="absolute bottom-[-11px] left-0 right-0 text-center text-[8px] text-gray-600 font-normal leading-none pointer-events-none">back</span>
                </button>
                <button id="btnTrashB" class="tool-btn py-1 rounded border border-panel panel-btn aspect-square flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" height="14" viewBox="0 -960 960 960" width="14" fill="currentColor"><path d="M261-120q-24.75 0-42.37-17.63Q201-155.25 201-180v-570h-41v-60h188v-30h264v30h188v60h-41v570q0 24-18 42t-42 18H261Zm438-630H261v570h438v-570ZM367-266h60v-399h-60v399Zm166 0h60v-399h-60v399ZM261-750v570-570Z"/></svg>
                </button>
            </div>
        </div>
        <div class="w-px h-6 bg-panel-divider shrink-0"></div>
        <div class="flex items-center gap-4 shrink-0">
            <div class="flex bg-panel-strong rounded p-0.5">
                <button id="eraseMode" class="tool-btn active px-2 py-0.5 rounded text-xs font-medium">Erase</button>
                <button id="repairMode" class="tool-btn px-2 py-0.5 rounded text-xs font-medium">Repair</button>
                <button id="patchMode" class="tool-btn px-2 py-0.5 rounded text-xs font-medium">Patch</button>
            </div>
            <div class="flex flex-col gap-0.5 w-24">
                <div class="flex justify-between text-xs text-gray-400">
                    <span>Size (%)</span>
                    <span id="brushSizeVal">10</span>
                </div>
                <input type="range" autocomplete="off" id="brushSize" min="0" max="1000" step="1" value="329" class="w-full">
            </div>
            <div class="flex items-center gap-2">
                <div class="flex flex-col gap-0.5 w-24">
                    <div class="flex justify-between text-xs text-gray-400">
                        <span id="featherLabel">Hardness</span>
                        <span id="featherVal">95%</span>
                    </div>
                    <input type="range" autocomplete="off" id="feather" min="0" max="20" value="1" class="w-full">
                </div>
            </div>
        </div>
        <div class="w-px h-6 bg-panel-divider shrink-0"></div>
        <div class="flex flex-col gap-0.5 w-24 shrink-0">
            <div class="flex justify-between text-xs text-gray-400">
                <span>Opacity</span>
                <span id="opacityVal">80%</span>
            </div>
            <input type="range" autocomplete="off" id="opacitySlider" min="0" max="100" value="80" class="w-full">
        </div>
        <div class="flex-1 flex items-center justify-center">
            <div class="mode-switcher flex items-center">
                <button id="modeMaster" class="mode-tab active" type="button">Master</button>
                <span class="mode-divider" aria-hidden="true">|</span>
                <button id="modeCensor" class="mode-tab" type="button">Censor</button>
                <span class="mode-divider" aria-hidden="true">|</span>
                <button id="modeComposite" class="mode-tab" type="button">Composite</button>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="helpBtn" class="tool-btn flex items-center justify-center w-8 h-8 rounded text-gray-400 hover:text-white" title="Help">
                 <img src="icons/help.svg" alt="Help" class="w-5 h-5" draggable="false">
            </button>
            <button id="settingsBtn" class="tool-btn flex items-center justify-center w-8 h-8 rounded text-gray-400 hover:text-white" title="Settings">
                 <img src="icons/settings.svg" alt="Settings" class="w-5 h-5" draggable="false">
            </button>
            <button id="saveBtn" class="tool-btn flex items-center gap-2 text-white px-3 py-1.5 rounded shadow text-xs font-medium accent-action" title="Save">
                <img src="icons/save.svg" alt="Save" class="w-4 h-4" draggable="false">
                <span>Save</span>
            </button>
            <button id="exportBtn" class="tool-btn flex items-center gap-2 text-white px-3 py-1.5 rounded shadow text-xs font-medium accent-action" title="Export">
                <img src="icons/export.svg" alt="Export" class="w-4 h-4" draggable="false">
                <span>Export</span>
            </button>
        </div>
    </div>

    <!-- Main Workspace -->
    <div id="canvas-container" class="checkerboard relative w-full flex-grow flex flex-col overflow-hidden">
        <div id="workspace-labels">
            <div class="workspace-label workspace-label-top" aria-hidden="true">
                <span class="workspace-label-okazu">OKAZU</span>
                <span class="workspace-label-studio">studio</span>
            </div>
            <div id="workspace-resolution" class="workspace-label workspace-label-bottom workspace-label-resolution" aria-hidden="true" style="display:none">
                0Ã—0
            </div>
        </div>
        <div id="empty-state" class="absolute inset-0 flex items-center justify-center text-gray-500 pointer-events-none z-10">
            <div class="text-center">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <p class="text-xl font-medium">Load or Drop two images</p>
                <p class="text-sm mt-2 opacity-75">Space to Pan &bull; Wheel to Zoom</p>
            </div>
        </div>
        
        <!-- Dark overlay for workspace when cropping -->
        <div id="backdrop-dimmer"></div>

        <div id="viewport" class="disabled">
            <div id="canvas-wrapper">
                <canvas id="mainCanvas" class="shadow-2xl hidden"></canvas>
                <canvas id="previewCanvas" class="shadow-2xl absolute inset-0 w-full h-full pointer-events-none hidden"></canvas>
                
                <!-- Crop UI Elements (DOM based) -->
                <div id="crop-overlay-dom">
                    <div id="crop-box">
                        <div class="crop-grid" aria-hidden="true">
                            <div class="crop-thirds-line crop-thirds-vertical crop-thirds-left"></div>
                            <div class="crop-thirds-line crop-thirds-vertical crop-thirds-right"></div>
                            <div class="crop-thirds-line crop-thirds-horizontal crop-thirds-top"></div>
                            <div class="crop-thirds-line crop-thirds-horizontal crop-thirds-bottom"></div>
                        </div>
                        <div class="crop-handle handle-nw" data-handle="nw"></div>
                        <div class="crop-handle handle-n" data-handle="n"></div>
                        <div class="crop-handle handle-ne" data-handle="ne"></div>
                        <div class="crop-handle handle-e" data-handle="e"></div>
                        <div class="crop-handle handle-sw" data-handle="sw"></div>
                        <div class="crop-handle handle-w" data-handle="w"></div>
                        <div class="crop-handle handle-se" data-handle="se"></div>
                        <div class="crop-handle handle-s" data-handle="s"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Panel Overlay -->
    <div id="preview-panel-overlay" class="hidden fixed z-[60] bg-panel-strong border border-panel rounded p-2 flex flex-col gap-2 pointer-events-none shadow-xl">
        <div class="relative flex-grow border border-panel-divider overflow-hidden flex items-center justify-center">
            <img id="preview-panel-img" class="max-w-full max-h-full object-contain" src="" alt="Preview">
        </div>
        <div id="preview-panel-text" class="text-[10px] text-gray-400 text-center font-mono leading-none"></div>
    </div>

    <script src="scripts/logging.js"></script>
    <script src="scripts/assets.js"></script>
    <script src="scripts/geometry.js"></script>
    <script src="scripts/state.js"></script>
    <script src="scripts/adjustments-core.js"></script>
    <script src="scripts/brush.js"></script>
    <script src="scripts/kakushi.js"></script>
    <script src="scripts/stego.js"></script>
    <script src="scripts/watermark.js"></script>
    <script src="scripts/replay.js"></script>
    <script src="scripts/adjustments.js"></script>
    <script src="scripts/input.js"></script>
    <script src="scripts/settings.js"></script>
    <script src="scripts/main.js"></script>
</body>
</html>
